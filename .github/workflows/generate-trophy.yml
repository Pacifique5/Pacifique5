name: Generate local trophy.svg

on:
  push:
    branches: [ main ]
  watch:
    types: [ started ]
  schedule:
    - cron: '0 * * * *'   # hourly
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate trophy.svg from GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: Pacifique5
          REPO: mfique
        run: |
          set -e
          OWNER="${OWNER}"
          REPO="${REPO}"
          AUTH="Authorization: token ${GITHUB_TOKEN}"
          API="https://api.github.com"

          # repo metadata
          repo_json=$(curl -s -H "$AUTH" "$API/repos/$OWNER/$REPO")
          stars=$(echo "$repo_json" | jq -r .stargazers_count // 0)
          forks=$(echo "$repo_json" | jq -r .forks_count // 0)
          watchers=$(echo "$repo_json" | jq -r .subscribers_count // 0)
          open_issues=$(echo "$repo_json" | jq -r .open_issues_count // 0)

          # total commits: sum contributions from contributors (includes anon)
          contributors=$(curl -s -H "$AUTH" "$API/repos/$OWNER/$REPO/contributors?per_page=100&anon=1")
          total_commits=$(echo "$contributors" | jq '[.[].contributions] | add' )
          total_commits=${total_commits:-0}

          # PRs and issues using search API
          pr_count=$(curl -s -H "$AUTH" "$API/search/issues?q=repo:$OWNER/$REPO+type:pr" | jq -r .total_count // 0)
          issue_count=$(curl -s -H "$AUTH" "$API/search/issues?q=repo:$OWNER/$REPO+type:issue" | jq -r .total_count // 0)

          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # create SVG (simple, readable)
          cat > trophy.svg <<EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="900" height="160" viewBox="0 0 900 160" role="img" aria-label="GitHub Trophies - Pacifique5">
            <rect width="100%" height="100%" fill="#0b1220"/>
            <text x="32" y="40" font-family="Inter, Arial, sans-serif" font-size="22" fill="#e6edf3">ğŸ† GitHub Trophies</text>
            <g font-family="Inter, Arial, sans-serif" font-size="16" fill="#cbd5e1">
              <text x="32" y="74">â­ Stars: $stars</text>
              <text x="220" y="74">ğŸ´ Forks: $forks</text>
              <text x="420" y="74">ğŸ‘ï¸ Watchers: $watchers</text>
              <text x="620" y="74">ğŸ§¾ Commits: $total_commits</text>

              <text x="32" y="106">ğŸ”€ PRs: $pr_count</text>
              <text x="220" y="106">ğŸ Issues: $issue_count</text>
            </g>
            <text x="32" y="140" font-family="Inter, Arial, sans-serif" font-size="12" fill="#74839a">Updated: $TIMESTAMP (generated by workflow)</text>
          </svg>
EOF

      - name: Commit and push trophy.svg (if changed)
        env:
          GIT_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_NAME: github-actions[bot]
        run: |
          git config user.email "$GIT_EMAIL"
          git config user.name "$GIT_NAME"
          git add trophy.svg || true
          if ! git diff --staged --quiet; then
            git commit -m "chore: update generated trophy.svg" || true
            git push origin HEAD:main
          else
            echo "No changes to trophy.svg"
          fi